<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        body {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100vh;
            margin: 0;
        }
        header, main {
            padding: 1rem;
        }
        header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        main {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            align-items: start;
            justify-items: center;
        }
        form {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
            width: 100%;
            max-width: 600px;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }
        input[type="button"] {
            padding: 0.5rem 1rem;
            border: 1px solid #007bff;
            border-radius: 0.25rem;
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        input[type="button"]:hover {
            background-color: #0056b3;
        }
        .error-message {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        <h2>게시글 수정</h2>
    </header>
    <main>
        <form name="updateForm">
            <!-- ID는 JavaScript를 통해 동적으로 설정됩니다. -->
            <input type="hidden" name="id">
            <label>writer: <input type="text" name="boardWriter" readonly></label>
            <label>title: <input type="text" name="boardTitle"></label>
            <label>pass: <input type="password" name="boardPass" id="board-pass"></label>
            <label>contents: <textarea name="boardContents" cols="30" rows="10"></textarea></label>
            <div id="error-message" class="error-message" style="display:none;">비밀번호가 틀립니다!!</div>
            <input type="button" value="수정">
        </form>
    </main>

    <script th:inline="javascript">
        // Thymeleaf를 사용하지 않는 순수 JavaScript 구현
        document.addEventListener("DOMContentLoaded", () => {
            // DOM 요소 캐싱
            const updateForm = document.forms.updateForm;
            const passwordInput = document.getElementById("board-pass");
            const errorMessage = document.getElementById("error-message");
            const updateButton = document.querySelector("input[type='button']");

            let storedPassword = ''; // 서버에서 받아온 비밀번호를 저장할 변수
            const boardId = window.location.pathname.split('/').pop(); // URL에서 ID 추출

            // 1. 서버에서 게시글 데이터 가져오기
            fetch(`/api/boards/${boardId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('게시글 정보를 불러오는데 실패했습니다.');
                    }
                    return response.json();
                })
                .then(board => {
                    // 2. 폼에 데이터 채우기
                    updateForm.id.value = board.id;
                    updateForm.boardWriter.value = board.boardWriter;
                    updateForm.boardTitle.value = board.boardTitle;
                    updateForm.boardContents.value = board.boardContents;
                    storedPassword = board.boardPass; // 비밀번호 저장
                })
                .catch(error => {
                    console.error(error);
                    alert(error.message);
                    window.location.href = '/list'; // 실패 시 목록으로 이동
                });

            // 3. '수정' 버튼 클릭 이벤트 처리
            const handleUpdateClick = () => {
                if (passwordInput.value !== storedPassword) {
                    errorMessage.style.display = "block";
                    return;
                }

                // 4. 서버에 수정 요청 보내기
                const updatedData = {
                    id: updateForm.id.value,
                    boardTitle: updateForm.boardTitle.value,
                    boardContents: updateForm.boardContents.value
                };

                fetch(`/api/boards/${boardId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                })
                .then(response => {
                    if (response.ok) {
                        alert('수정이 완료되었습니다.');
                        window.location.href = `/${boardId}`; // 수정 후 상세 페이지로 이동
                    } else {
                        throw new Error('수정에 실패했습니다.');
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert(error.message);
                });
            };

            updateButton.addEventListener("click", handleUpdateClick);
        });
    </script>
</body>
</html>
